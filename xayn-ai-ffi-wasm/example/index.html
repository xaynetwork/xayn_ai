<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
  </head>
  <body>
    <script type="module">
      import init, { WXaynAi } from "./pkg/xayn_ai_ffi_wasm.js";

      async function run() {
        await init();

        console.time("load_data");
        let smbert_vocab = await window.fetch("data/smbert_v0000/vocab.txt");
        let smbert_model = await window.fetch("data/smbert_v0000/smbert.onnx");
        let qambert_vocab = await window.fetch("data/qambert_v0001/vocab.txt");
        let qambert_model = await window.fetch(
          "data/qambert_v0001/qambert.onnx"
        );
        let ltr_model = await window.fetch("data/ltr_v0000/ltr.binparams");
        let smbert_vocab_buf = new Uint8Array(await smbert_vocab.arrayBuffer());
        let smbert_model_buf = new Uint8Array(await smbert_model.arrayBuffer());
        let qambert_vocab_buf = new Uint8Array(
          await qambert_vocab.arrayBuffer()
        );
        let qambert_model_buf = new Uint8Array(
          await qambert_model.arrayBuffer()
        );
        let ltr_model_buf = new Uint8Array(await ltr_model.arrayBuffer());
        console.timeEnd("load_data");

        console.time("init_ai");
        let ai;
        try {
          ai = new WXaynAi(
            smbert_vocab_buf,
            smbert_model_buf,
            qambert_vocab_buf,
            qambert_model_buf,
            ltr_model_buf,
            undefined,
          );
        } catch (e) {
          if (e instanceof WebAssembly.RuntimeError) {
            // Panic
          } else {
            console.log(e);
          }
          throw e;
        }
        console.timeEnd("init_ai");

        console.time("rerank");
        let ranks = ai.rerank(1, [], documents());
        console.timeEnd("rerank");
        console.log(ranks);

        let faults = ai.faults();
        console.log(faults);

        let data = ai.serialize();
        console.log(data);

        ai.rerank(1, history(), documents());
        console.log(ai.rerank(1, history(), documents()));

        let analytics = ai.analytics();
        console.log(analytics);

        // Free the xaynai instance
        ai.free();
      }

      function history() {
        return [
          {
            id: "fcb6a685-eb92-4d36-8686-000000000000",
            relevance: 0,
            user_feedback: 1,
            session: "fcb6a685-eb92-4d36-8686-000000000001",
            query_count: 1,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            day: 0,
            url: "url-0",
            domain: "domain-0",
            rank: 0,
            user_action: 0,
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000001",
            relevance: 1,
            user_feedback: 1,
            session: "fcb6a685-eb92-4d36-8686-000000000001",
            query_count: 2,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            day: 1,
            url: "url-1",
            domain: "domain-1",
            rank: 1,
            user_action: 0,
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000002",
            relevance: 2,
            user_feedback: 1,
            session: "fcb6a685-eb92-4d36-8686-000000000001",
            query_count: 3,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            day: 2,
            url: "url-2",
            domain: "domain-2",
            rank: 2,
            user_action: 1,
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000003",
            relevance: 0,
            user_feedback: 1,
            session: "fcb6a685-eb92-4d36-8686-000000000001",
            query_count: 4,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            day: 3,
            url: "url-3",
            domain: "domain-3",
            rank: 3,
            user_action: 2,
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000004",
            relevance: 1,
            user_feedback: 1,
            session: "fcb6a685-eb92-4d36-8686-000000000001",
            query_count: 5,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            day: 4,
            url: "url-4",
            domain: "domain-4",
            rank: 4,
            user_action: 0,
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000005",
            relevance: 2,
            user_feedback: 1,
            session: "fcb6a685-eb92-4d36-8686-000000000001",
            query_count: 6,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            day: 5,
            url: "url-5",
            domain: "domain-5",
            rank: 5,
            user_action: 1,
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000006",
            relevance: 0,
            user_feedback: 0,
            session: "fcb6a685-eb92-4d36-8686-000000000001",
            query_count: 7,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            day: 6,
            url: "url-6",
            domain: "domain-6",
            rank: 6,
            user_action: 2,
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000007",
            relevance: 1,
            user_feedback: 0,
            session: "fcb6a685-eb92-4d36-8686-000000000001",
            query_count: 8,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            day: 0,
            url: "url-7",
            domain: "domain-7",
            rank: 7,
            user_action: 0,
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000008",
            relevance: 2,
            user_feedback: 0,
            session: "fcb6a685-eb92-4d36-8686-000000000001",
            query_count: 9,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            day: 1,
            url: "url-8",
            domain: "domain-8",
            rank: 8,
            user_action: 1,
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000009",
            relevance: 2,
            user_feedback: 0,
            session: "fcb6a685-eb92-4d36-8686-000000000001",
            query_count: 10,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            day: 2,
            url: "url-9",
            domain: "domain-9",
            rank: 9,
            user_action: 2,
          },
        ];
      }

      function documents() {
        return [
          {
            id: "fcb6a685-eb92-4d36-8686-000000000000",
            rank: 0,
            title: "ship",
            snippet: "ship snippet",
            session: "fcb6a685-eb92-4d36-8686-000000000002",
            query_count: 1,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            url: "url-0",
            domain: "domain-0",
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000001",
            rank: 1,
            title: "car",
            snippet: "car snippet",
            session: "fcb6a685-eb92-4d36-8686-000000000002",
            query_count: 2,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            url: "url-1",
            domain: "domain-1",
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000002",
            rank: 2,
            title: "auto",
            snippet: "auto snippet",
            session: "fcb6a685-eb92-4d36-8686-000000000002",
            query_count: 3,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            url: "url-2",
            domain: "domain-2",
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000003",
            rank: 3,
            title: "flugzeug",
            snippet: "flugzeug snippet",
            session: "fcb6a685-eb92-4d36-8686-000000000002",
            query_count: 4,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            url: "url-3",
            domain: "domain-3",
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000004",
            rank: 4,
            title: "plane",
            snippet: "plane snippet",
            session: "fcb6a685-eb92-4d36-8686-000000000002",
            query_count: 5,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            url: "url-4",
            domain: "domain-4",
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000005",
            rank: 5,
            title: "vehicle",
            snippet: "vehicle snippet",
            session: "fcb6a685-eb92-4d36-8686-000000000002",
            query_count: 6,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            url: "url-5",
            domain: "domain-5",
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000006",
            rank: 6,
            title: "truck",
            snippet: "truck snippet",
            session: "fcb6a685-eb92-4d36-8686-000000000002",
            query_count: 7,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            url: "url-6",
            domain: "domain-6",
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000007",
            rank: 7,
            title: "trunk",
            snippet: "trunk snippet",
            session: "fcb6a685-eb92-4d36-8686-000000000002",
            query_count: 8,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            url: "url-7",
            domain: "domain-7",
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000008",
            rank: 8,
            title: "motorbike",
            snippet: "motorbike snippet",
            session: "fcb6a685-eb92-4d36-8686-000000000002",
            query_count: 9,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            url: "url-8",
            domain: "domain-8",
          },
          {
            id: "fcb6a685-eb92-4d36-8686-000000000009",
            rank: 9,
            title: "bicycle",
            snippet: "bicycle snippet",
            session: "fcb6a685-eb92-4d36-8686-000000000002",
            query_count: 10,
            query_id: "fcb6a685-eb92-4d36-8686-000000000001",
            query_words: "transport mode",
            url: "url-9",
            domain: "domain-9",
          },
        ];
      }

      run();
    </script>
  </body>
</html>
