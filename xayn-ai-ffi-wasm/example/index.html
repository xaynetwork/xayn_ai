<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
  </head>
  <body>
    <script type="module">
      import init, { WXaynAi } from "./pkg/xayn_ai_ffi_wasm.js";

      async function run() {
        await init();

        console.time("load_data");
        let vocab = await get_data("data/rubert_v0001/vocab.txt");
        let model = await get_data("data/rubert_v0001/smbert.onnx");
        let vocab_buffer = new Uint8Array(vocab);
        let model_buffer = new Uint8Array(model);
        console.timeEnd("load_data");

        console.time("init_ai");
        var ai = undefined;
        try {
          ai = new WXaynAi(vocab_buffer, model_buffer, undefined);
        } catch (e) {
          if (e instanceof WebAssembly.RuntimeError) {
            // Panic
          } else {
            console.log(e);
          }
          throw e;
        }
        console.timeEnd("init_ai");

        console.time("rerank");
        let ranks = ai.rerank([], documents());
        console.timeEnd("rerank");
        console.log(ranks);

        let faults = ai.faults();
        console.log(faults);

        let data = ai.serialize();
        console.log(data);

        ai.rerank(history(), documents());
        console.log(ai.rerank(history(), documents()));

        let analytics = ai.analytics();
        console.log(analytics);

        // Free the xaynai instance
        ai.free();
      }

      function history() {
        return [
          {
            id: '00000000-0000-0000-0000-000000000001',
            relevance: 0,
            feedback: 1,
          },
          {
            id: '00000000-0000-0000-0000-000000000002',
            relevance: 1,
            feedback: 1,
          },
          {
            id: '00000000-0000-0000-0000-000000000003',
            relevance: 2,
            feedback: 1,
          },
          {
            id: '00000000-0000-0000-0000-000000000004',
            relevance: 0,
            feedback: 1,
          },
          {
            id: '00000000-0000-0000-0000-000000000005',
            relevance: 1,
            feedback: 1,
          },
          {
            id: '00000000-0000-0000-0000-000000000006',
            relevance: 2,
            feedback: 1,
          },
          {
            id: '00000000-0000-0000-0000-000000000007',
            relevance: 0,
            feedback: 0,
          },
          {
            id: '00000000-0000-0000-0000-000000000008',
            relevance: 1,
            feedback: 0,
          },
          {
            id: '00000000-0000-0000-0000-000000000009',
            relevance: 2,
            feedback: 0,
          },
          {
            id: '00000000-0000-0000-0000-00000000000a',
            relevance: 2,
            feedback: 0,
          },
        ];
      }

      function documents() {
        return [
          {
            id: '00000000-0000-0000-0000-000000000001',
            rank: 0,
            snippet: "ship",
          },
          {
            id: '00000000-0000-0000-0000-000000000002',
            rank: 1,
            snippet: "car",
          },
          {
            id: '00000000-0000-0000-0000-000000000003',
            rank: 2,
            snippet: "auto",
          },
          {
            id: '00000000-0000-0000-0000-000000000004',
            rank: 3,
            snippet: "flugzeug",
          },
          {
            id: '00000000-0000-0000-0000-000000000005',
            rank: 4,
            snippet: "plane",
          },
          {
            id: '00000000-0000-0000-0000-000000000006',
            rank: 5,
            snippet: "vehicle",
          },
          {
            id: '00000000-0000-0000-0000-000000000007',
            rank: 6,
            snippet: "truck",
          },
          {
            id: '00000000-0000-0000-0000-000000000008',
            rank: 7,
            snippet: "trunk",
          },
          {
            id: '00000000-0000-0000-0000-000000000009',
            rank: 8,
            snippet: "motorbike",
          },
          {
            id: '00000000-0000-0000-0000-00000000000a',
            rank: 9,
            snippet: "bicycle",
          },
        ];
      }

      async function get_data(url) {
        return new Promise(function (resolve, reject) {
          let xhr = new XMLHttpRequest();
          xhr.open("GET", url, true);
          xhr.responseType = "arraybuffer";
          xhr.onload = function () {
            if (this.status >= 200 && this.status < 300) {
              resolve(xhr.response);
            } else {
              reject({
                status: this.status,
                statusText: xhr.statusText,
              });
            }
          };
          xhr.onerror = function () {
            reject({
              status: this.status,
              statusText: xhr.statusText,
            });
          };
          xhr.send();
        });
      }

      run();
    </script>
  </body>
</html>
