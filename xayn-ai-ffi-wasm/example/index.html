<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
  </head>
  <body>
    <script type="module">
      import init, {WXaynAi} from './pkg/xayn_ai_ffi_wasm.js';

      async function run() {
        await init();

        console.time("load_data");
        let vocab = await get_data("data/rubert_v0000/vocab.txt");
        let model = await get_data("data/rubert_v0000/model.onnx");
        let vocab_buffer =  new Uint8Array(vocab);
        let model_buffer =  new Uint8Array(model);
        console.timeEnd("load_data");

        console.time("init_ai");
        var ai = undefined;
        try {
            ai = new WXaynAi(vocab_buffer, model_buffer, undefined);
        }
        catch (e) {
            if (e instanceof WebAssembly.RuntimeError) {
                // Panic
            } else {
                 console.log(e);
            }
            throw e;
        }
        console.timeEnd("init_ai");

        console.time("rerank");
        let ranks = ai.rerank([], documents());
        console.timeEnd("rerank");
        console.log(ranks);

        let faults = ai.faults();
        console.log(faults);

        let data = ai.serialize();
        console.log(data);

        ai.rerank(history(), documents());
        ai.rerank(history(), documents());

        let analytics = ai.analytics();
        console.log(analytics);

        // Free the xaynai instance
        ai.free();
      }

      function history() {
        return [
            {
                "id": "0",
                "relevance": "Low",
                "user_feedback": "Irrelevant"
            },
            {
                "id": "1",
                "relevance": "Medium",
                "user_feedback": "Irrelevant"
            }
            ,
            {
                "id": "2",
                "relevance": "High",
                "user_feedback": "Irrelevant"
            }
            ,
            {
                "id": "3",
                "relevance": "Low",
                "user_feedback": "Irrelevant"
            }
            ,
            {
                "id": "4",
                "relevance": "Medium",
                "user_feedback": "Irrelevant"
            }
            ,
            {
                "id": "5",
                "relevance": "High",
                "user_feedback": "Irrelevant"
            }
            ,
            {
                "id": "6",
                "relevance": "Low",
                "user_feedback": "Relevant"
            }
            ,
            {
                "id": "7",
                "relevance": "Medium",
                "user_feedback": "Relevant"
            }
            ,
            {
                "id": "8",
                "relevance": "High",
                "user_feedback": "Relevant"
            }
            ,
            {
                "id": "9",
                "relevance": "High",
                "user_feedback": "Relevant"
            }

        ]
      }

      function documents() {
        return [{
            "id": "0",
            "rank": 0,
            "snippet": "ship",
        },{
            "id": "1",
            "rank": 1,
            "snippet": "car",
        },{
            "id": "2",
            "rank": 2,
            "snippet": "auto",
        },{
            "id": "3",
            "rank": 3,
            "snippet": "flugzeug",
        },{
            "id": "4",
            "rank": 4,
            "snippet": "plane",
        },{
            "id": "5",
            "rank": 5,
            "snippet": "vehicle",
        },{
            "id": "6",
            "rank": 6,
            "snippet": "truck",
        },{
            "id": "7",
            "rank": 7,
            "snippet": "trunk",
        },{
            "id": "8",
            "rank": 8,
            "snippet": "motorbike",
        },{
            "id": "9",
            "rank": 9,
            "snippet": "bicycle",
        }]
      }

      async function get_data(url) {
        return new Promise(function (resolve, reject) {
            let xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.responseType = "arraybuffer";
            xhr.onload = function () {
                if (this.status >= 200 && this.status < 300) {
                    resolve(xhr.response);
                } else {
                    reject({
                        status: this.status,
                        statusText: xhr.statusText
                    });
                }
            };
            xhr.onerror = function () {
                reject({
                    status: this.status,
                    statusText: xhr.statusText
                });
            };
            xhr.send();
        });
      }

      run();
    </script>
  </body>
</html>
